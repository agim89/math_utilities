name: Build & Publish RC Packages

on:
  pull_request:
    types: [labeled]

jobs:
  get-sha:
    runs-on: ubuntu-latest
    outputs:
      short_sha: ${{ steps.sha.outputs.short_sha }}
    steps:
      - uses: actions/checkout@v4
      - id: sha
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

  rc-build:
    needs: get-sha
    if: github.event.label.name == 'publish'
    uses: agim89/shared-workflows/.github/workflows/conan-package.yml@main
    with:
      version: 1.2.0-dev-
      remote: conan-rc
      is_rc: true
    secrets: inherit

  consumer-verify:
    needs: [rc-build, get-sha]
    if: github.event.label.name == 'publish'
    uses: agim89/shared-workflows/.github/workflows/consumer-verify.yml@main
    with:
      version: 1.2.0-dev-
      remote: conan-rc
      git_sha: ${{ needs.get-sha.outputs.short_sha }}
    secrets: inherit
