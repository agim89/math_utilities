name: Release Notes

on:
  pull_request:
    types:
      - closed
    branches:
      - main

permissions:
  contents: write

jobs:
  release-notes-on-merge:
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Dependencies
        run: pip install bump2version

      # ðŸ”¹ NEW: Determine release type from PR labels
      - name: Determine release type
        id: release_type
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels) }}'
          echo "PR Labels: $LABELS"

          if echo "$LABELS" | grep -q '"name":"major"'; then
            echo "type=major" >> $GITHUB_OUTPUT
            echo "Detected: major release"
          elif echo "$LABELS" | grep -q '"name":"minor"'; then
            echo "type=minor" >> $GITHUB_OUTPUT
            echo "Detected: minor release"
          else
            echo "type=patch" >> $GITHUB_OUTPUT
            echo "Detected: patch release (default)"
          fi

      - name: Release new version
        env:
          RELEASE_LOGS_FOLDER: Release-Notes
          RELEASE_TYPE: ${{ steps.release_type.outputs.type }}
        run: |
          set -e

          RELEASE_FILE_NAME_PREFIX="Release"

          if [ ! -s "$RELEASE_LOGS_FOLDER/unreleased.md" ]; then
            echo "unreleased.md is empty. Skipping release."
            exit 0
          fi

          echo "Releasing a $RELEASE_TYPE version"
          bump2version "$RELEASE_TYPE" --config-file setup.cpg --allow-dirty
          
          # Verify bump2version worked
          echo "Checking updated files:"
          cat Release-Notes/__version__.py
          cat VERSION
          cat setup.cpg | grep current_version

          # Get the new version after bump
          VERSION=$(cat Release-Notes/__version__.py | grep -oP '(?<=")\d+\.\d+\.\d+(?=")')
          echo "Updated version: $VERSION"
          MINOR_VERSION="${VERSION%.*}"

          # Create Release file for the NEW version (e.g., Release-1.4.md)
          RELEASE_FILE="$RELEASE_LOGS_FOLDER/$RELEASE_FILE_NAME_PREFIX-$MINOR_VERSION.md"

          echo "New version: $VERSION"
          echo "Release file: $RELEASE_FILE"

          # Create or append to the release file
          if [ ! -f "$RELEASE_FILE" ]; then
            echo "Creating new release file: $RELEASE_FILE"
            echo "# Release Notes - Version $MINOR_VERSION.x" > "$RELEASE_FILE"
            echo "" >> "$RELEASE_FILE"
          fi

          # Prepend the new version and content from unreleased.md
          TMP_FILE="$RELEASE_FILE.tmp"
          echo "## $VERSION" > "$TMP_FILE"
          echo "" >> "$TMP_FILE"
          cat "$RELEASE_LOGS_FOLDER/unreleased.md" >> "$TMP_FILE"
          echo "" >> "$TMP_FILE"
          echo "" >> "$TMP_FILE"
          cat "$RELEASE_FILE" >> "$TMP_FILE" || true
          mv "$TMP_FILE" "$RELEASE_FILE"

          # Clear unreleased.md
          : > "$RELEASE_LOGS_FOLDER/unreleased.md"

          git config user.email "agim-18@hotmail.com"
          git config user.name "Release Bot"

          git add --all
          git commit -m "Release version $VERSION"
          git push origin HEAD:main